{% extends 'base.html' %}
{% block content %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Tasks</h2>
                <a href="{% url 'app:create_task' %}" class="btn btn-primary">Create Task</a>
            </div>
            {% if tasks %}
                <ul class="list-group">
                    {% for task in tasks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center task-item">
                            <div class="task-content {% if task.status == 'DONE' %}task-done{% endif %}">
                                <h5 class="mb-1 {% if task.status == 'DONE' %}task-title-done{% endif %}">{{ task.title }}</h5>
                                <p class="mb-1 {% if task.status == 'DONE' %}task-description-done{% endif %}">
                                    {{ task.description|truncatewords:20|default:"No description" }}
                                    {% if task.description|wordcount > 20 %}
                                        <a href="{% url 'app:task_detail' task_slug=task.slug %}" class="text-primary">... Read more</a>
                                    {% endif %}
                                </p>
                                <button class="mark-complete btn btn-sm btn-success" data-task-slug="{{ task.slug }}" data-status="{{ task.status }}">âœ”</button>
                                <br>
                                <small>Due: {% if task.due_date %}{{ task.due_date|date:"Y-m-d H:i" }}{% else %}No due date{% endif %}</small><br>
                                <small>Created: {% if task.created_at %}{{ task.created_at|date:"Y-m-d H:i" }}{% else %}Unknown{% endif %}</small>
                            </div>
                            <div>
                                <form method="post" action="{% url 'app:delete_task' task_slug=task.slug %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                                <a href="{% url 'app:task_detail' task_slug=task.slug %}" class="btn btn-info btn-sm">View Details</a>
                                <a href="{% url 'app:task_update' task_slug=task.slug %}" class="btn btn-warning btn-sm">Edit</a>
                            </div>
                        </li>
                    {% endfor %}
                </ul>

                {% if paginator.num_pages > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mt-4">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}

                            {% for num in paginator.page_range %}
                                <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paginator.num_pages }}">Last &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            {% else %}
                <p class="text-center">No tasks yet. <a href="{% url 'app:create_task' %}">Create one</a>.</p>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.mark-complete');
            console.log('Found buttons:', buttons.length);

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');
            console.log('CSRF Token:', csrftoken);

            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Button clicked for task:', this.dataset.taskSlug);
                    const taskSlug = this.dataset.taskSlug;
                    const currentStatus = this.dataset.status;
                    const newStatus = currentStatus === 'DONE' ? 'TODO' : 'DONE';

                    fetch(`/update-task-status/${taskSlug}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ status: newStatus })
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            const taskItem = button.closest('.task-item');
                            const taskContent = taskItem.querySelector('.task-content');
                            const taskTitle = taskItem.querySelector('h5');
                            const taskDescription = taskItem.querySelector('p');

                            if (newStatus === 'DONE') {
                                taskContent.classList.add('task-done');
                                taskTitle.classList.add('task-title-done');
                                taskDescription.classList.add('task-description-done');
                            } else {
                                taskContent.classList.remove('task-done');
                                taskTitle.classList.remove('task-title-done');
                                taskDescription.classList.remove('task-description-done');
                            }

                            button.dataset.status = newStatus;
                        } else {
                            alert('Error updating status: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('Error: ' + error);
                    });
                });
            });
        });
    </script>
{% endblock %}